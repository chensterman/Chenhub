#!/bin/sh

echo "ğŸ” Running pre-commit checks..."

# â”€â”€ 1. No .env files staged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ENV_FILES=$(git diff --cached --name-only | grep -E '^\.env(\.|$)')
if [ -n "$ENV_FILES" ]; then
  echo "âŒ Blocked: .env file(s) staged for commit:"
  echo "$ENV_FILES"
  echo "   Remove them with: git reset HEAD <file>"
  exit 1
fi

# â”€â”€ 2. No SQL / migration files staged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SQL_FILES=$(git diff --cached --name-only | grep -E '(^migrations/|\.sql$)')
if [ -n "$SQL_FILES" ]; then
  echo "âŒ Blocked: SQL/migration file(s) staged for commit:"
  echo "$SQL_FILES"
  echo "   These are kept locally only (see .gitignore)."
  echo "   Remove them with: git reset HEAD <file>"
  exit 1
fi

# â”€â”€ 3. No Supabase URLs or anon keys in staged content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Anon keys are JWTs â€” they always start with "eyJ"
# Supabase project URLs contain ".supabase.co"
STAGED_CONTENT=$(git diff --cached -U0 | grep '^+' | grep -v '^+++')
if echo "$STAGED_CONTENT" | grep -qE '\.supabase\.co|eyJ[A-Za-z0-9_-]{20,}'; then
  echo "âŒ Blocked: Possible Supabase URL or anon key found in staged changes."
  echo "   Use environment variables via \$env/static/public instead."
  exit 1
fi

# â”€â”€ 4. No Svelte 4 syntax in staged .svelte files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SVELTE_FILES=$(git diff --cached --name-only | grep '\.svelte$')
if [ -n "$SVELTE_FILES" ]; then
  SVELTE4_HITS=""

  for f in $SVELTE_FILES; do
    # export let (Svelte 4 props)
    if git show ":$f" | grep -qE '^\s*export let '; then
      SVELTE4_HITS="$SVELTE4_HITS\n  $f: uses 'export let' (use \$props() instead)"
    fi
    # $: reactive statements
    if git show ":$f" | grep -qE '^\s*\$:'; then
      SVELTE4_HITS="$SVELTE4_HITS\n  $f: uses '\$:' reactive statement (use \$derived/\$effect instead)"
    fi
    # <slot /> or <slot>
    if git show ":$f" | grep -qE '<slot[\s/>]'; then
      SVELTE4_HITS="$SVELTE4_HITS\n  $f: uses '<slot>' (use {@render children()} instead)"
    fi
  done

  if [ -n "$SVELTE4_HITS" ]; then
    echo "âŒ Blocked: Svelte 4 syntax detected (this project uses Svelte 5 runes):"
    printf "$SVELTE4_HITS\n"
    exit 1
  fi
fi

# â”€â”€ 5. Type check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“ Type checking..."
TMPFILE=$(mktemp)
pnpm check > "$TMPFILE" 2>&1
if [ $? -ne 0 ]; then
  cat "$TMPFILE"
  rm -f "$TMPFILE"
  echo "âŒ Type check failed. Commit aborted."
  exit 1
fi
rm -f "$TMPFILE"

# â”€â”€ 6. Production build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ—ï¸  Building for production..."
TMPFILE=$(mktemp)
pnpm build > "$TMPFILE" 2>&1
if [ $? -ne 0 ]; then
  cat "$TMPFILE"
  rm -f "$TMPFILE"
  echo "âŒ Build failed. Commit aborted."
  exit 1
fi
rm -f "$TMPFILE"

echo "âœ… All checks passed!"
exit 0
